# Subpub-project
Это простая система подписки и публикации (Pub/Sub), реализованная с использованием gRPC. Она поддерживает подписку на темы, публикацию сообщений и возможность закрывать соединения.

## Стек 
- [Go](https://golang.org/) — язык программирования для сервера
- [gRPC](https://grpc.io/) — для общения между сервисами
- [Protocol Buffers](https://developers.google.com/protocol-buffers) — для описания сообщений и сервисов
- [Testify](https://github.com/stretchr/testify) — для тестирования
- [Protoc](https://grpc.io/docs/protoc-installation/) — компилятор для Protocol Buffers


## Установка и запуск проекта

### 1. Клонирование репозитория
```bash
git clone https://github.com/voronkov44/subpub-project.git
```

### 2. Переход в корневую директорию 
```bash
cd subpub-project
```

### 3. Запуск проекта
#### 3.1. Открываем первый терминал и запускаем gRPC сервер
```bash
go run cmd/main.go
```

#### 3.2. Открываем второй терминал и подписываемся на топик(слушаем порт):
```bash
grpcurl -plaintext -d '{"key":"test-topic"}' localhost:50051 subpub.PubSub/Subscribe
```

#### 3.3. Открываем третий терминал и публикуем сообщение в топик:
```bash
grpcurl -plaintext -d '{"key":"test-topic", "data":"Hellol!"}' localhost:50051 subpub.PubSub/Publish
```

## 4. Тесты
В проекте реализовано 4 unit-теста:
| Тест                                 | Что проверяет                                                             |
| :----------------------------------- | :------------------------------------------------------------------------ |
| `TestMultipleIndependentSubscribers` | Независимость подписчиков и получение всех сообщений в правильном порядке |
| `TestPublishSubscribe`               | Корректную доставку сообщения подписчику                                  |
| `TestUnsubscribe`                    | Корректную работу отписки от топика                                       |
| `TestCloseWithContextCancel`         | Обработку отмены контекста при закрытии                                   |


### Описание тестов:

1. `TestMultipleIndependentSubscribers`

**Что проверяет:**

Что несколько независимых подписчиков на один топик получают все опубликованные сообщения в правильном порядке, независимо от скорости обработки сообщений.

**Как работает:**

- Создаются 3 подписчика на топик test-topic.

- Каждый подписчик сохраняет принятые сообщения в свой слайс.

- Второй подписчик искусственно «медленный» (пауза в 200 мс).

- Публикуются 3 сообщения.

- Проверяется, что все подписчики получили все 3 сообщения в правильном порядке.

- Если хотя бы один не успеет — тест упадёт по таймауту 3 сек.

**Этот тест гарантирует, что подписчики работают независимо и получают все сообщения без потерь.**



2. `TestPublishSubscribe`


**Что проверяет:**

Что публикация сообщения успешно доставляет его подписчику.

**Как работает:**

- Создаётся подписчик на test-topic.

- Публикуется сообщение "hello".

- Подписчик проверяет, что получил именно "hello".

- Завершается после получения.

- Подписка отписывается.

**Минимальный sanity check, что публикация и подписка работают.**

3. `TestUnsubscribe`


**Что проверяет:**

Что отписка от подписки действительно предотвращает получение сообщений.

**Как работает:**

- Создаётся подписчик на topic.

- Подписчик сразу отписывается.

- Публикуется сообщение.

- Проверяется, что обработчик не был вызван (флаг called остался false).

**Тестирует корректность работы метода Unsubscribe.**

4. `TestCloseWithContextCancel`

**Что проверяет:**

Что метод Close корректно обрабатывает отменённый контекст.

**Как работает:**

- Создаётся контекст с отменой.

- Вызывается sp.Close(ctx).

- Проверяется, что метод вернул context.Canceled.

**Это проверка корректной обработки отмены контекста при закрытии pubsub'a.**

















## Зависимости
### 
Для установки на MacOS я использовал Homebrew:
```bash
brew install grpcurl
```
Для установки на Linux воспользуйтесь следующей командой:
```bash
sudo apt-get install grpcurl
